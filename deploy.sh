#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –¥–ª—è Timeweb Cloud VPS
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy.sh

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∏–∑–º–µ–Ω–∏—Ç–µ –ø–æ–¥ –≤–∞—à –ø—Ä–æ–µ–∫—Ç)
PROJECT_DIR="/var/www/–≤–∞—à-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
BRANCH="main"
NPM_CMD="npm"

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}–ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –ø—Ä–æ–µ–∫—Ç–∞${NC}"
echo -e "${GREEN}========================================${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d "$PROJECT_DIR" ]; then
    echo -e "${RED}–û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $PROJECT_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞${NC}"
    exit 1
fi

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$PROJECT_DIR" || exit 1

echo -e "${YELLOW}–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)${NC}"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git
echo -e "${GREEN}[1/5] –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git...${NC}"
git fetch origin
git reset --hard origin/$BRANCH
git clean -fd

# –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç
echo -e "${GREEN}–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:${NC}"
git log -1 --oneline

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo -e "${GREEN}[2/5] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
$NPM_CMD install --production=false

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è .env.production
if [ ! -f ".env.production" ]; then
    echo -e "${YELLOW}–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª .env.production –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    echo -e "${YELLOW}–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã${NC}"
fi

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
echo -e "${GREEN}[3/5] –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...${NC}"
$NPM_CMD run build

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
if [ ! -d "dist" ]; then
    echo -e "${RED}–û—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ dist –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏${NC}"
    exit 1
fi

echo -e "${GREEN}–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ${NC}"
echo -e "${GREEN}–†–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ dist: $(du -sh dist | cut -f1)${NC}"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx
echo -e "${GREEN}[4/5] –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx...${NC}"
if systemctl is-active --quiet nginx; then
    systemctl reload nginx
    echo -e "${GREEN}Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω${NC}"
else
    echo -e "${YELLOW}–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: Nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
fi

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PM2
if command -v pm2 &> /dev/null; then
    echo -e "${GREEN}[5/5] –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...${NC}"
    pm2 restart all || echo -e "${YELLOW}PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${NC}"
fi

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ! üöÄ${NC}"
echo -e "${GREEN}========================================${NC}"

# –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ
echo -e "${YELLOW}–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ:${NC}"
echo -e "Node.js: $(node --version)"
echo -e "NPM: $(npm --version)"
echo -e "–î–∞—Ç–∞: $(date)"
