#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ Timeweb Cloud –ë–ï–ó Git
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./update-without-git.sh

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# ============================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - –ò–ó–ú–ï–ù–ò–¢–ï –ü–û–î –í–ê–® –°–ï–†–í–ï–†
# ============================================
SERVER_IP="–≤–∞—à-ip-–∞–¥—Ä–µ—Å"
SERVER_USER="root"
REMOTE_DIR="/var/www/your-app"
LOCAL_DIST_DIR="./dist"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================
# –§–£–ù–ö–¶–ò–ò
# ============================================

print_header() {
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}========================================${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_info() {
    echo -e "${YELLOW}‚ÑπÔ∏è  $1${NC}"
}

# ============================================
# –ü–†–û–í–ï–†–ö–ò
# ============================================

print_header "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –∞–¥—Ä–µ—Å–∞
if [ "$SERVER_IP" == "–≤–∞—à-ip-–∞–¥—Ä–µ—Å" ]; then
    print_error "–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω SERVER_IP –≤ —Å–∫—Ä–∏–ø—Ç–µ!"
    echo "–û—Ç–∫—Ä–æ–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏ –∏–∑–º–µ–Ω–∏—Ç–µ SERVER_IP –Ω–∞ IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–∞–ø–∫–∏ dist
if [ ! -d "$LOCAL_DIST_DIR" ]; then
    print_error "–ü–∞–ø–∫–∞ $LOCAL_DIST_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    print_info "–°–æ–±–∏—Ä–∞—é –ø—Ä–æ–µ–∫—Ç..."
    npm run build
    
    if [ ! -d "$LOCAL_DIST_DIR" ]; then
        print_error "–°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å –∏–ª–∏ –ø–∞–ø–∫–∞ dist –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
        exit 1
    fi
fi

print_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"

# ============================================
# –°–ë–û–†–ö–ê –ü–†–û–ï–ö–¢–ê
# ============================================

print_header "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"

print_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if [ ! -d "node_modules" ]; then
    print_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    npm install
fi

print_info "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

if [ ! -d "$LOCAL_DIST_DIR" ]; then
    print_error "–°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å!"
    exit 1
fi

print_success "–ü—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ"
print_info "–†–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ dist: $(du -sh $LOCAL_DIST_DIR | cut -f1)"

# ============================================
# –°–û–ó–î–ê–ù–ò–ï –ê–†–•–ò–í–ê
# ============================================

print_header "–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞"

ARCHIVE_NAME="dist-update-$(date +%Y%m%d-%H%M%S).tar.gz"
print_info "–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: $ARCHIVE_NAME"

tar -czf "$ARCHIVE_NAME" -C "$LOCAL_DIST_DIR" .

if [ ! -f "$ARCHIVE_NAME" ]; then
    print_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤!"
    exit 1
fi

ARCHIVE_SIZE=$(du -sh "$ARCHIVE_NAME" | cut -f1)
print_success "–ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $ARCHIVE_NAME ($ARCHIVE_SIZE)"

# ============================================
# –ó–ê–ì–†–£–ó–ö–ê –ù–ê –°–ï–†–í–ï–†
# ============================================

print_header "–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä"

print_info "–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp "$ARCHIVE_NAME" "$SERVER_USER@$SERVER_IP:/tmp/"

if [ $? -ne 0 ]; then
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞!"
    rm -f "$ARCHIVE_NAME"
    exit 1
fi

print_success "–ê—Ä—Ö–∏–≤ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä"

# ============================================
# –û–ë–ù–û–í–õ–ï–ù–ò–ï –ù–ê –°–ï–†–í–ï–†–ï
# ============================================

print_header "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"

print_info "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."

ssh "$SERVER_USER@$SERVER_IP" << ENDSSH
    set -e
    
    echo "–ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
    cd $REMOTE_DIR
    
    if [ ! -d "$REMOTE_DIR" ]; then
        echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $REMOTE_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
        exit 1
    fi
    
    echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
    if [ -d "dist" ]; then
        BACKUP_NAME="dist-backup-\$(date +%Y%m%d-%H%M%S)"
        mv dist "\$BACKUP_NAME"
        echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: \$BACKUP_NAME"
    fi
    
    echo "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏ dist..."
    mkdir -p dist
    
    echo "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞..."
    tar -xzf /tmp/$ARCHIVE_NAME -C dist/
    
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
    chown -R www-data:www-data dist
    chmod -R 755 dist
    
    echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤..."
    if [ ! -f "dist/index.html" ]; then
        echo "‚ùå –§–∞–π–ª index.html –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
    fi
    
    echo "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx..."
    systemctl reload nginx
    
    echo "–û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
    rm -f /tmp/$ARCHIVE_NAME
    
    # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
    find $REMOTE_DIR -maxdepth 1 -type d -name "dist-backup-*" -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
    
    echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
ENDSSH

if [ $? -ne 0 ]; then
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!"
    rm -f "$ARCHIVE_NAME"
    exit 1
fi

# ============================================
# –ó–ê–í–ï–†–®–ï–ù–ò–ï
# ============================================

print_header "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ"

print_info "–û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
rm -f "$ARCHIVE_NAME"

print_success "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
print_info "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: http://$SERVER_IP"
print_info "–ò–ª–∏ –ø–æ –¥–æ–º–µ–Ω—É, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}–ì–æ—Ç–æ–≤–æ! üöÄ${NC}"
echo -e "${GREEN}========================================${NC}"
